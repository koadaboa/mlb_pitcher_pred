# MLB Pitcher Strikeout Prediction

## Overview

This project builds a machine learning pipeline to predict the number of strikeouts a pitcher will achieve in an upcoming Major League Baseball (MLB) game. It involves fetching data from various sources, extensive feature engineering focusing on rolling statistics, model training using LightGBM with hyperparameter optimization, and making daily predictions.

## Core Pipeline

The project follows these main steps:

1.  **Data Fetching:** Retrieves raw data (Statcast, schedules, team stats, umpire assignments) using `pybaseball` and web scraping (ESPN).
2.  **Data Aggregation:** Processes pitch-level Statcast data into game-level summaries for pitchers and batters.
3.  **Feature Engineering:** Calculates numerous features based on historical performance, including rolling averages for pitchers, opponents, ballparks, and umpires, as well as pitcher rest days.
4.  **Model Training:** Trains a LightGBM model (using Poisson regression) on the historical features, incorporating feature selection and hyperparameter tuning (Optuna).
5.  **Prediction:** Uses the trained model and newly generated features to predict strikeouts for upcoming games.

## Project Structure
mlb_pred/
├── models/
├── data/
├── logs/
├── notebooks/
├── plots/
├── README.md
├── requirements.txt
├── setup.py
├── src/
    ├── config.py               # Configuration file for paths, API keys, features, params
    ├── data/
    │   ├── aggregate_statcast.py # Aggregates raw Statcast data
    │   └── utils.py            # Utility functions for data handling (e.g., DB connection)
    │   └── mlb_api.py          # (Potentially contains pybaseball/API interactions - check content)
    ├── features/
    │   ├── ballpark_features.py  # Generates ballpark-related features
    │   ├── opponent_features.py # Generates opponent-related features
    │   ├── pitcher_features.py  # Generates pitcher-related features
    │   ├── umpire_features.py   # Generates umpire-related features
    │   └── selection.py         # Feature selection logic (VIF, SHAP)
    ├── models/
    │   └── train_lgb_model.py   # Trains the LightGBM model using Optuna
    ├── scripts/
    │   ├── data_fetcher.py      # Main script to fetch all required data
    │   ├── generate_features.py # Main script to generate features from aggregated data
    │   ├── predict_today.py     # Generates predictions for a given date
    │   └── scrape_espn_data.py  # Script specifically for scraping ESPN (e.g., umpires)
    ├── *.csv                   # Supporting CSV files (mappings, subsets)
    └── mlb_pred.egg-info/      # Package metadata (generated by setuptools/pip)
## Setup

1.  **Clone the Repository:**
    ```bash
    git clone <your-repo-url>
    cd <your-repo-name>
    ```
2.  **Create Environment (Recommended):**
    ```bash
    python -m venv venv
    source venv/bin/activate  # On Windows use `venv\Scripts\activate`
    ```
3.  **Install Dependencies:**
    *(Note: Create a `requirements.txt` file based on imports if one doesn't exist)*
    ```bash
    pip install -r requirements.txt
    # Or manually install:
    # pip install pandas numpy lightgbm optuna pybaseball scikit-learn joblib requests beautifulsoup4 selenium aiohttp # Add others as needed
    ```
4.  **Configure:**
    * Edit `src/config.py` to set the correct database path (`DB_PATH`), potentially update API keys or placeholders, and review feature lists/parameters.
    * Ensure necessary drivers (like ChromeDriver for Selenium) are installed and accessible if running scraping scripts locally.
5.  **Database:** The pipeline uses an SQLite database (`mlb_data.db` by default, as defined in `config.py`). The initial data fetching step will create and populate this database.

## Usage

Run the scripts in the following order. Use command-line arguments where applicable (e.g., for dates). Check individual scripts using `-h` or `--help` for available arguments if `argparse` is implemented.

1.  **Fetch Data:**
    ```bash
    python src/scripts/data_fetcher.py --start_date YYYY-MM-DD --end_date YYYY-MM-DD
    ```
    *(Note: You might need to run `src/scripts/scrape_espn_data.py` separately or ensure it's called correctly by `data_fetcher.py`)*

2.  **Aggregate Statcast Data (if needed separately):**
    *(This logic might be included within data_fetcher or generate_features - verify script contents)*
    ```bash
    # Example if standalone:
    # python src/data/aggregate_statcast.py --start_date YYYY-MM-DD --end_date YYYY-MM-DD
    ```

3.  **Generate Features:**
    ```bash
    python src/scripts/generate_features.py --start_date YYYY-MM-DD --end_date YYYY-MM-DD [--mode historical|prediction]
    ```
    *(Specify dates covering the range needed for rolling calculations and the target prediction/training dates)*

4.  **Train Model:**
    ```bash
    python src/models/train_lgb_model.py --training_end_date YYYY-MM-DD
    ```
    *(This will train on data up to the specified end date)*

5.  **Make Predictions:**
    ```bash
    python src/scripts/predict_today.py --prediction_date YYYY-MM-DD
    ```
    *(This will fetch data, generate features for the prediction date, and use the latest trained model)*

6.  **Analyze Residuals:**
    ```bash
    python src/scripts/analyze_residuals.py
    ```
    *(Loads the latest model, evaluates the test set, and saves residual plots to `plots/`)*

## Configuration

Key configurations are managed in `src/config.py`:

* `DB_PATH`: Path to the SQLite database.
* API Keys/Credentials: Placeholders for any required API keys.
* Feature Definitions: Lists defining features for pitchers, opponents, ballparks, umpires, and rolling window sizes.
* Model Parameters: Base parameters for LightGBM, Optuna trial settings, feature selection methods and thresholds.
* Logging Settings.

## Dependencies

* Python (>= 3.8 recommended)
* pandas
* numpy
* LightGBM
* Optuna
* pybaseball
* scikit-learn
* joblib / pickle
* requests / httpx / aiohttp (for web requests)
* BeautifulSoup4 (for HTML parsing)
* Selenium (for browser automation/scraping)
* SQLite3 (standard library)
* concurrent.futures (standard library)
* logging, argparse, datetime, pathlib (standard libraries)

*(Ensure all necessary libraries are captured in a `requirements.txt` file for easy installation.)*